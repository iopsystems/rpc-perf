# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Release

on:
  push:
    tags:
      - "v*"

permissions: write-all

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL: sparse
  RUST_BACKTRACE: 1
  DEBIAN_FRONTEND: noninteractive

  # Use zstd maximum compression for versions of dpkg which support it.
  #
  # Note that dpkg only checks these environment variables after version 1.21.10
  DPKG_DEB_COMPRESSOR_TYPE: zstd
  DPKG_DEB_COMPRESSOR_LEVEL: 22

jobs:
  build-deb:
    name: "deb ${{ matrix.distro }}:${{ matrix.release }} (${{ matrix.arch }})"
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    container: "${{ matrix.distro }}:${{ matrix.release }}"
    strategy:
      matrix:
        include:
          - { distro: debian, release: bullseye, arch: x86_64 }
          - { distro: debian, release: bullseye, arch: arm64 }
          - { distro: debian, release: bookworm, arch: x86_64 }
          - { distro: debian, release: bookworm, arch: arm64 }

          - { distro: ubuntu, release: jammy, arch: x86_64 } # 22.04
          - { distro: ubuntu, release: jammy, arch: arm64 } # 22.04
          - { distro: ubuntu, release: noble, arch: x86_64 } # 24.04
          - { distro: ubuntu, release: noble, arch: arm64 } # 24.04
      fail-fast: false
    env:
      # dpkg-buildpackage issues a warning if we attempt to cross compile and
      # tests are still enabled. Disabling the test step fixes this.
      #
      # Note that we don't run tests anyway so this doesn't really change
      # anything for us.
      DEB_BUILD_OPTS: nocheck
    steps:
      - uses: actions/checkout@v4

      - name: install buildsystem apt dependencies
        run: |
          apt-get update
          apt-get install -y            \
            build-essential             \
            curl jq lsb-release unzip gpg pkg-config libzstd-dev libssl-dev

      - name: install rust
        run: |
          curl -sSf https://sh.rustup.rs | sh /dev/stdin -y
          echo "PATH=$HOME/.cargo/bin:$PATH" >> "$GITHUB_ENV"

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-deb-${{ matrix.distro }}-${{ matrix.release }}-${{ matrix.arch }}

      - name: check cargo
        shell: bash
        run: |
          echo "::group::rustc -vV"
          rustc -vV
          echo "::endgroup::"
          echo "::group::cargo -vV"
          cargo -vV
          echo "::endgroup::"

      # Changelogs with revisions cause dpkg-source to emit an error when
      # building. We only use the source package to install the build deps
      # so building it with an invalid version is ok.
      - name: build source package
        run: dpkg-source --build .

      - name: generate changelog
        shell: bash
        run: ./debian/gen-changelog.sh > debian/changelog

      - name: install build dependencies
        run: apt-get build-dep -y ../rpc-perf*.dsc

      - name: build package
        run: dpkg-buildpackage -b -us -uc

      - name: copy debs
        shell: bash
        run: |
          shopt -s nullglob
          mkdir -p target/debian
          cp ../*.deb ../*.ddeb target/debian/

      - uses: actions/upload-artifact@v4
        with:
          path: target/debian/*
          name: deb_${{ matrix.distro }}_${{ matrix.release }}_${{ matrix.arch }}

  build-rpm:
    name: "rpm ${{ matrix.distro }}:${{ matrix.version }} (${{ matrix.arch }})"
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    container: "${{ matrix.distro }}:${{ matrix.version }}"
    strategy:
      matrix:
        include:
          - { distro: rockylinux, version: 9, arch: x86_64 }
          - { distro: rockylinux, version: 9, arch: arm64 }
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: install rust
        run: |
          curl -sSf https://sh.rustup.rs | sh /dev/stdin -y
          echo "PATH=$HOME/.cargo/bin:$PATH" >> "$GITHUB_ENV"

      - name: install build dependencies
        shell: bash
        run: |
          dnf install -y --enablerepo=devel protobuf-compiler
          yum install -y git gcc gcc-c++ cmake elfutils-devel clang openssl-devel pkg-config perl-base perl-File-Compare perl-File-Copy perl-FindBin perl-IPC-Cmd

      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: build-rpm-${{ matrix.distro }}-${{ matrix.version}}-${{ matrix.arch }}

      - name: install rpm packaging tool
        run: cargo install cargo-generate-rpm

      - name: check cargo
        shell: bash
        run: |
          echo "::group::rustc -vV"
          rustc -vV
          echo "::endgroup::"
          echo "::group::cargo -vV"
          cargo -vV
          echo "::endgroup::"

      - name: build
        shell: bash
        run: |
          cargo build --release --locked

      - name: package
        shell: bash
        run: |
          cargo generate-rpm

      - uses: actions/upload-artifact@v4
        with:
          path: target/generate-rpm/*
          name: rpm_${{ matrix.distro }}_${{ matrix.version }}_${{ matrix.arch }}

  publish:
    name: Publish release artifacts
    runs-on: ubuntu-latest
    needs:
      - build-deb
      - build-rpm
    steps:
      - uses: actions/checkout@v4

      # Download deb artifacts
      - uses: actions/download-artifact@v4
        with:
          path: target/artifacts/
          pattern: deb_*

      # Download rpm artifacts
      - uses: actions/download-artifact@v4
        with:
          path: target/rpm/
          pattern: rpm_*

      # Upload debs to systemslab registry
      - uses: google-github-actions/auth@v1
        with:
          credentials_json: "${{ secrets.GCP_CREDENTIALS }}"

      - uses: google-github-actions/setup-gcloud@v1

      - name: upload debs to systemslab registry
        run: |
          gcloud config set artifacts/repository systemslab
          gcloud config set artifacts/location us

          for artifact in target/artifacts/deb_*/*; do
            [ -f "$artifact" ] || continue
            name="$(basename "$artifact")"
            directory="$(basename "$(dirname "$artifact")")"
            # directory format: deb_<distro>_<release>_<arch>
            release="$(echo "$directory" | cut -d _ -f 3)"

            echo "::group::upload $release $name"
            gcloud artifacts apt upload "$release" --source "$artifact"
            echo "::endgroup::"
          done

      # Create GitHub release with all artifacts
      - name: prepare release artifacts
        run: |
          mkdir -p target/release-artifacts

          # Collect deb packages
          for artifact in target/artifacts/deb_*/*; do
            [ -f "$artifact" ] || continue
            name="$(basename "$artifact")"
            directory="$(basename "$(dirname "$artifact")")"
            distro="$(echo "$directory" | cut -d _ -f 2)"
            release="$(echo "$directory" | cut -d _ -f 3)"
            arch="$(echo "$directory" | cut -d _ -f 4)"
            mv "$artifact" "target/release-artifacts/${distro}_${release}_${arch}_${name}"
          done

          # Collect rpm packages
          for artifact in target/rpm/rpm_*/*; do
            [ -f "$artifact" ] || continue
            name="$(basename "$artifact")"
            directory="$(basename "$(dirname "$artifact")")"
            distro="$(echo "$directory" | cut -d _ -f 2)"
            version="$(echo "$directory" | cut -d _ -f 3)"
            arch="$(echo "$directory" | cut -d _ -f 4)"
            mv "$artifact" "target/release-artifacts/${distro}_${version}_${arch}_${name}"
          done

      - name: extract changelog
        id: changelog
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"

          CHANGELOG=$(awk '/^## \['"$VERSION"'\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md | sed '/^$/d')

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release v$VERSION"
          fi

          echo "$CHANGELOG" > /tmp/release-notes.md

      - name: create GitHub release
        run: |
          gh release create "${{ github.ref_name }}" \
            --title "${{ github.ref_name }}" \
            --notes-file /tmp/release-notes.md \
            target/release-artifacts/*
